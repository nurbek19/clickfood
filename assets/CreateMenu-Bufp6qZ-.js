import{r as x,j as e,u as I,W as C}from"./index-CVEvCaTa.js";import{u as U}from"./useDishes-ClA2u9Wj.js";import{u as F}from"./index-DYfCB7Kb.js";import{h as S}from"./index-DhNbZf-v.js";const M=({dishes:t,onEdit:r})=>{var a;const[g,p]=x.useState(((a=t==null?void 0:t[0])==null?void 0:a.category)??"");if(t.length===0)return e.jsx("p",{children:"Нет блюд"});const u=t.reduce((l,h,m)=>{const c=h.category||"Без категории";return l[c]||(l[c]=[]),l[c].push({...h,index:m}),l},{});return e.jsxs("div",{className:"dish-list-container",children:[e.jsx("div",{className:"dish-categories-container",children:Object.keys(u).map(l=>e.jsxs("label",{className:"radio-input-label",children:[e.jsx("input",{type:"radio",name:"houseType",value:l,className:"radio-input",checked:g===l,onChange:h=>p(h.target.value)}),e.jsx("span",{className:"radio-input-text",children:l})]},l))}),e.jsx("div",{className:"dish-list",children:u[g]&&u[g].map(l=>e.jsxs("div",{className:"dish-card",children:[e.jsx("div",{className:"dish-card-image",children:e.jsx("img",{src:`https://booklink.pro/cf/photo?id=${l.photo}`,alt:""})}),e.jsxs("div",{className:"dish-details",children:[e.jsxs("span",{className:"dish-price",children:[l.price," сом"]}),e.jsxs("span",{className:"dish-weight",children:[l.weight," г / мл"]})]}),e.jsx("p",{className:"dish-title",children:l.name}),e.jsx("button",{className:"secondary-button",onClick:()=>r(l),children:"Редактировать"})]},l._id))})]})},z=({dish:t,categories:r,setCategories:g,onSave:p,onCancel:u})=>{const[a,l]=x.useState({...t}),[h,m]=x.useState(!1),[c,v]=x.useState(""),y=x.useCallback(async i=>{var o;const s=i[0],n=new FormData;n.append("photo",s);try{const f=await S.post("/photo/upload",n,{headers:{"Content-Type":"multipart/form-data"}});(o=f.data)!=null&&o.id&&l(b=>({...b,photo:f.data.id}))}catch(f){console.error("Upload error:",f)}},[]),{getRootProps:N,getInputProps:j}=F({accept:{"image/*":[]},maxFiles:1,onDrop:y}),_=i=>{const s=i.target.value;s==="__new__"?(m(!0),l(n=>({...n,category:""}))):(m(!1),l(n=>({...n,category:s})))},w=()=>{const i=h?c.trim():a.category;if(!a.name||!a.price||!a.weight||!i||!a.photo){alert("Заполните все поля");return}const s={...a,price:parseInt(a.price),weight:parseInt(a.weight),category:i};r.includes(i)||g(n=>[...n,i]),p(s)};return e.jsx("div",{children:e.jsxs("div",{onClick:i=>i.stopPropagation(),children:[e.jsx("h3",{children:"Редактировать блюдо"}),e.jsxs("div",{className:"field-wrapper",children:[e.jsx("label",{htmlFor:"name",className:"field-label",children:"Название"}),e.jsx("input",{type:"text",id:"name",className:"text-field",value:a.name,onChange:i=>l(s=>({...s,name:i.target.value}))})]}),e.jsxs("div",{className:"group-form",children:[e.jsxs("div",{className:"field-wrapper",children:[e.jsx("label",{htmlFor:"price",className:"field-label",children:"Цена"}),e.jsx("input",{type:"number",id:"price",className:"text-field",value:a.price,onChange:i=>l(s=>({...s,price:i.target.value}))})]}),e.jsxs("div",{className:"field-wrapper",children:[e.jsx("label",{htmlFor:"weight",className:"field-label",children:"Вес / объем"}),e.jsx("input",{type:"text",id:"weight",className:"text-field",value:a.weight,onChange:i=>l(s=>({...s,weight:i.target.value}))})]})]}),e.jsxs("div",{className:"field-wrapper select-wrapper",children:[e.jsx("label",{htmlFor:"category",className:"field-label",children:"Категория"}),e.jsxs("select",{id:"category",className:"select-field",value:h?"__new__":a.category,onChange:_,children:[e.jsx("option",{value:"",disabled:!0,children:"Выбрать категорию"}),r.map((i,s)=>e.jsx("option",{value:i,children:i},s)),e.jsx("option",{value:"__new__",children:"Добавить новую категорию"})]})]}),h&&e.jsxs("div",{className:"field-wrapper",children:[e.jsx("label",{htmlFor:"new-category",className:"field-label",children:"Новая категория"}),e.jsx("input",{id:"new-category",type:"text",className:"text-field",value:c,onChange:i=>v(i.target.value)})]}),e.jsxs("div",{className:"field-wrapper",children:[e.jsx("label",{htmlFor:"description",className:"field-label",children:"Описание"}),e.jsx("textarea",{id:"description",rows:"3",className:"text-field",value:a.description,onChange:i=>l(s=>({...s,description:i.target.value}))})]}),e.jsx("div",{className:"field-wrapper",children:e.jsxs("label",{className:"switch",children:[e.jsx("input",{type:"checkbox",checked:a.active,onChange:i=>l(s=>({...s,active:i.target.checked}))}),e.jsx("span",{className:"slider round"}),e.jsx("span",{children:"Скрыть из меню"})]})}),e.jsxs("div",{...N(),className:"dish-form-upload",children:[e.jsx("input",{...j()}),e.jsxs("button",{className:"dish-upload-button",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512",children:e.jsx("path",{d:"M288 109.3L288 352c0 17.7-14.3 32-32 32s-32-14.3-32-32l0-242.7-73.4 73.4c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l128-128c12.5-12.5 32.8-12.5 45.3 0l128 128c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L288 109.3zM64 352l128 0c0 35.3 28.7 64 64 64s64-28.7 64-64l128 0c35.3 0 64 28.7 64 64l0 32c0 35.3-28.7 64-64 64L64 512c-35.3 0-64-28.7-64-64l0-32c0-35.3 28.7-64 64-64zM432 456a24 24 0 1 0 0-48 24 24 0 1 0 0 48z"})}),a.photo?"Заменить фотографию":"Загрузить изображение"]}),a.photo&&e.jsx("img",{src:`https://booklink.pro/cf/photo?id=${a.photo}`,alt:"dish"})]}),e.jsxs("div",{className:"edit-buttons",children:[e.jsx("button",{onClick:w,className:"primary-button",children:"Применить изменения"}),e.jsx("button",{onClick:u,className:"secondary-button",children:"Отмена"})]})]})})},d=[];for(let t=0;t<256;++t)d.push((t+256).toString(16).slice(1));function B(t,r=0){return(d[t[r+0]]+d[t[r+1]]+d[t[r+2]]+d[t[r+3]]+"-"+d[t[r+4]]+d[t[r+5]]+"-"+d[t[r+6]]+d[t[r+7]]+"-"+d[t[r+8]]+d[t[r+9]]+"-"+d[t[r+10]]+d[t[r+11]]+d[t[r+12]]+d[t[r+13]]+d[t[r+14]]+d[t[r+15]]).toLowerCase()}let k;const E=new Uint8Array(16);function T(){if(!k){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");k=crypto.getRandomValues.bind(crypto)}return k(E)}const R=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),D={randomUUID:R};function A(t,r,g){var u;if(D.randomUUID&&!t)return D.randomUUID();t=t||{};const p=t.random??((u=t.rng)==null?void 0:u.call(t))??T();if(p.length<16)throw new Error("Random bytes length must be >= 16");return p[6]=p[6]&15|64,p[8]=p[8]&63|128,B(p)}const P=({dishes:t,setDishes:r,categories:g,setCategories:p,setEditingDish:u})=>{const[a,l]=x.useState({name:"",price:"",weight:"",category:"",description:"",active:!1,photo:""}),[h,m]=x.useState(!1),[c,v]=x.useState(""),y=x.useCallback(async s=>{var f;const n=s[0],o=new FormData;o.append("photo",n);try{const b=await S.post("/photo/upload",o,{headers:{"Content-Type":"multipart/form-data"}});(f=b.data)!=null&&f.id&&l(L=>({...L,photo:b.data.id}))}catch(b){console.error("Upload error:",b)}},[]),{getRootProps:N,getInputProps:j}=F({accept:{"image/*":[]},maxFiles:1,onDrop:y}),_=s=>{const n=s.target.value;n==="__new__"?(m(!0),l(o=>({...o,category:""}))):(m(!1),l(o=>({...o,category:n})))},w=()=>{const s=t.length===0||h?c.trim():a.category;if(!a.name||!a.price||!a.weight||!s||!a.photo){alert("Заполните все поля");return}const n={...a,price:parseInt(a.price),weight:parseInt(a.weight),category:s,temp_id:A()};r(o=>[...o,n]),g.includes(s)||p(o=>[...o,s]),l({name:"",price:"",weight:"",category:"",description:"",active:!1,photo:""}),v(""),m(!1)},i=s=>{r(n=>n.filter(o=>(o==null?void 0:o.temp_id)!==s))};return e.jsxs("div",{children:[e.jsxs("div",{className:"field-wrapper",children:[e.jsx("label",{htmlFor:"name",className:"field-label",children:"Название"}),e.jsx("input",{type:"text",id:"name",className:"text-field",value:a.name,onChange:s=>l(n=>({...n,name:s.target.value}))})]}),e.jsxs("div",{className:"group-form",children:[e.jsxs("div",{className:"field-wrapper",children:[e.jsx("label",{htmlFor:"price",className:"field-label",children:"Цена"}),e.jsx("input",{type:"number",id:"price",className:"text-field",value:a.price,onChange:s=>l(n=>({...n,price:s.target.value}))})]}),e.jsxs("div",{className:"field-wrapper",children:[e.jsx("label",{htmlFor:"weight",className:"field-label",children:"Вес / объем"}),e.jsx("input",{type:"text",id:"weight",className:"text-field",value:a.weight,onChange:s=>l(n=>({...n,weight:s.target.value}))})]})]}),t.length>0?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"field-wrapper select-wrapper",children:[e.jsx("label",{htmlFor:"category",className:"field-label",children:"Категория"}),e.jsxs("select",{id:"category",className:"select-field",value:h?"__new__":a.category,onChange:_,children:[e.jsx("option",{value:"",disabled:!0,children:"Выбрать категорию"}),g.map((s,n)=>e.jsx("option",{value:s,children:s},n)),e.jsx("option",{value:"__new__",children:"Добавить новую категорию"})]})]}),h&&e.jsxs("div",{className:"field-wrapper",children:[e.jsx("label",{htmlFor:"new-category",className:"field-label",children:"Новая категория"}),e.jsx("input",{id:"new-category",type:"text",className:"text-field",value:c,onChange:s=>v(s.target.value)})]})]}):e.jsxs("div",{className:"field-wrapper",children:[e.jsx("label",{htmlFor:"first-category",className:"field-label",children:"Категория"}),e.jsx("input",{id:"first",type:"text",className:"text-field",value:c,onChange:s=>v(s.target.value)})]}),e.jsxs("div",{className:"field-wrapper",children:[e.jsx("label",{htmlFor:"description",className:"field-label",children:"Описание"}),e.jsx("textarea",{id:"description",rows:"3",className:"text-field",value:a.description,onChange:s=>l(n=>({...n,description:s.target.value}))})]}),e.jsx("div",{className:"field-wrapper",children:e.jsxs("label",{className:"switch",children:[e.jsx("input",{type:"checkbox",checked:a.active,onChange:s=>l(n=>({...n,active:s.target.checked}))}),e.jsx("span",{className:"slider round"}),e.jsx("span",{children:"Скрыть из меню"})]})}),e.jsxs("div",{...N(),className:"dish-form-upload",children:[e.jsx("input",{...j()}),e.jsxs("button",{className:"dish-upload-button",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512",children:e.jsx("path",{d:"M288 109.3L288 352c0 17.7-14.3 32-32 32s-32-14.3-32-32l0-242.7-73.4 73.4c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l128-128c12.5-12.5 32.8-12.5 45.3 0l128 128c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L288 109.3zM64 352l128 0c0 35.3 28.7 64 64 64s64-28.7 64-64l128 0c35.3 0 64 28.7 64 64l0 32c0 35.3-28.7 64-64 64L64 512c-35.3 0-64-28.7-64-64l0-32c0-35.3 28.7-64 64-64zM432 456a24 24 0 1 0 0-48 24 24 0 1 0 0 48z"})}),a.photo?"Заменить фотографию":"Загрузить изображение"]}),a.photo&&e.jsx("img",{src:`https://booklink.pro/cf/photo?id=${a.photo}`,alt:"dish"})]}),e.jsx("button",{className:"secondary-button",onClick:w,children:"Добавить блюдо"}),e.jsx("div",{className:"new-dishes-container",children:t.filter(s=>!s._id).map(s=>e.jsxs("div",{className:"food-badge",children:[e.jsx("p",{children:s.name}),e.jsxs("div",{className:"action-buttons",children:[e.jsx("button",{onClick:()=>u(s),children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512",children:e.jsx("path",{d:"M362.7 19.3L314.3 67.7 444.3 197.7l48.4-48.4c25-25 25-65.5 0-90.5L453.3 19.3c-25-25-65.5-25-90.5 0zm-71 71L58.6 323.5c-10.4 10.4-18 23.3-22.2 37.4L1 481.2C-1.5 489.7 .8 498.8 7 505s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L421.7 220.3 291.7 90.3z"})})}),e.jsx("button",{onClick:()=>i(s.temp_id),children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 448 512",children:e.jsx("path",{d:"M135.2 17.7L128 32 32 32C14.3 32 0 46.3 0 64S14.3 96 32 96l384 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-96 0-7.2-14.3C307.4 6.8 296.3 0 284.2 0L163.8 0c-12.1 0-23.2 6.8-28.6 17.7zM416 128L32 128 53.2 467c1.6 25.3 22.6 45 47.9 45l245.8 0c25.3 0 46.3-19.7 47.9-45L416 128z"})})})]})]},s.temp_id))})]})},H=()=>{const[t]=I(),r=t.get("chat_id"),{dishes:g,setDishes:p,categories:u,setCategories:a,isChanged:l,getChangedDishes:h}=U({partnerId:r}),[m,c]=x.useState(null),[v,y]=x.useState("create"),N=x.useCallback(()=>{const j=h();C.sendData(JSON.stringify(j))},[h]);return x.useEffect(()=>(C.MainButton.setText("Обновить меню"),l?C.MainButton.show():C.MainButton.hide(),C.onEvent("mainButtonClicked",N),()=>C.offEvent("mainButtonClicked",N)),[l,N]),e.jsxs("div",{className:"create-menu-container",children:[e.jsxs("div",{className:"field-wrapper",children:[e.jsx("span",{className:"field-label",children:"Добавить блюдо или редактировать меню:"}),e.jsxs("div",{className:"operation-type-switchers",children:[e.jsxs("label",{className:"radio-input-label",children:[e.jsx("input",{type:"radio",name:"operation",value:"create",className:"radio-input",checked:v==="create",onChange:j=>y(j.target.value)}),e.jsx("span",{className:"radio-input-text",children:"Добавить"})]}),e.jsxs("label",{className:"radio-input-label",children:[e.jsx("input",{type:"radio",name:"operation",value:"edit",className:"radio-input",checked:v==="edit",onChange:j=>y(j.target.value)}),e.jsx("span",{className:"radio-input-text",children:"Меню"})]})]})]}),m!==null?e.jsxs("div",{children:[e.jsx("button",{className:"back-button",onClick:()=>c(null),children:"« Назад"}),e.jsx(z,{dish:m,categories:u,setCategories:a,onSave:j=>{p(_=>_.map(w=>{const i=w._id&&m._id&&w._id===m._id,s=w.temp_id&&m.temp_id&&w.temp_id===m.temp_id;return i||s?j:w})),c(null)},onCancel:()=>c(null)})]}):e.jsx(e.Fragment,{children:v==="create"?e.jsx(P,{dishes:g,setDishes:p,categories:u,setCategories:a,setEditingDish:c}):e.jsx(M,{dishes:g,onEdit:c})})]})};export{H as default};
