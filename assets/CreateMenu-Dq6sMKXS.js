import{r as d,j as e,u as M,W as _}from"./index-f83BQRY7.js";import{u as L,d as S}from"./index-CAIescX4.js";import{a as D}from"./tslib.es6-CxTiUbDI.js";const u=[];for(let a=0;a<256;++a)u.push((a+256).toString(16).slice(1));function U(a,n=0){return(u[a[n+0]]+u[a[n+1]]+u[a[n+2]]+u[a[n+3]]+"-"+u[a[n+4]]+u[a[n+5]]+"-"+u[a[n+6]]+u[a[n+7]]+"-"+u[a[n+8]]+u[a[n+9]]+"-"+u[a[n+10]]+u[a[n+11]]+u[a[n+12]]+u[a[n+13]]+u[a[n+14]]+u[a[n+15]]).toLowerCase()}let k;const B=new Uint8Array(16);function E(){if(!k){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");k=crypto.getRandomValues.bind(crypto)}return k(B)}const z=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),F={randomUUID:z};function A(a,n,v){var f;if(F.randomUUID&&!a)return F.randomUUID();a=a||{};const p=a.random??((f=a.rng)==null?void 0:f.call(a))??E();if(p.length<16)throw new Error("Random bytes length must be >= 16");return p[6]=p[6]&15|64,p[8]=p[8]&63|128,U(p)}const T=({dishes:a,setDishes:n,categories:v,setCategories:p,setEditingDish:f})=>{const[t,l]=d.useState({name:"",price:"",weight:"",category:"",description:"",active:!1,photo:""}),[c,g]=d.useState(!1),[x,w]=d.useState(""),y=d.useCallback(async s=>{var N;const r=s[0],m=new FormData;m.append("photo",r);try{const C=await D.post("/photo/upload",m,{headers:{"Content-Type":"multipart/form-data"}});(N=C.data)!=null&&N.id&&l(I=>({...I,photo:C.data.id}))}catch(C){console.error("Upload error:",C)}},[]),{getRootProps:b,getInputProps:j}=L({accept:{"image/*":[]},maxFiles:1,onDrop:y}),o=s=>{const r=s.target.value;r==="__new__"?(g(!0),l(m=>({...m,category:""}))):(g(!1),l(m=>({...m,category:r})))},h=()=>{const s=a.length===0||c?x.trim():t.category;if(!t.name||!t.price||!t.weight||!s||!t.photo){alert("Заполните все поля");return}const r={...t,price:parseInt(t.price),weight:parseInt(t.weight),category:s,temp_id:A()};n(m=>[...m,r]),v.includes(s)||p(m=>[...m,s]),l({name:"",price:"",weight:"",category:"",description:"",active:!1,photo:""}),w(""),g(!1)},i=s=>{n(r=>r.filter(m=>(m==null?void 0:m.temp_id)!==s))};return e.jsxs("div",{children:[e.jsxs("div",{className:"field-wrapper",children:[e.jsx("label",{htmlFor:"name",className:"field-label",children:"Название"}),e.jsx("input",{type:"text",id:"name",className:"text-field",value:t.name,onChange:s=>l(r=>({...r,name:s.target.value}))})]}),e.jsxs("div",{className:"group-form",children:[e.jsxs("div",{className:"field-wrapper",children:[e.jsx("label",{htmlFor:"price",className:"field-label",children:"Цена"}),e.jsx("input",{type:"number",id:"price",className:"text-field",value:t.price,onChange:s=>l(r=>({...r,price:s.target.value}))})]}),e.jsxs("div",{className:"field-wrapper",children:[e.jsx("label",{htmlFor:"weight",className:"field-label",children:"Вес / объем"}),e.jsx("input",{type:"text",id:"weight",className:"text-field",value:t.weight,onChange:s=>l(r=>({...r,weight:s.target.value}))})]})]}),a.length>0?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"field-wrapper select-wrapper",children:[e.jsx("label",{htmlFor:"category",className:"field-label",children:"Категория"}),e.jsxs("select",{id:"category",className:"select-field",value:c?"__new__":t.category,onChange:o,children:[e.jsx("option",{value:"",disabled:!0,children:"Выбрать категорию"}),v.map((s,r)=>e.jsx("option",{value:s,children:s},r)),e.jsx("option",{value:"__new__",children:"Добавить новую категорию"})]})]}),c&&e.jsxs("div",{className:"field-wrapper",children:[e.jsx("label",{htmlFor:"new-category",className:"field-label",children:"Новая категория"}),e.jsx("input",{id:"new-category",type:"text",className:"text-field",value:x,onChange:s=>w(s.target.value)})]})]}):e.jsxs("div",{className:"field-wrapper",children:[e.jsx("label",{htmlFor:"first-category",className:"field-label",children:"Категория"}),e.jsx("input",{id:"first",type:"text",className:"text-field",value:x,onChange:s=>w(s.target.value)})]}),e.jsxs("div",{className:"field-wrapper",children:[e.jsx("label",{htmlFor:"description",className:"field-label",children:"Описание"}),e.jsx("textarea",{id:"description",rows:"3",className:"text-field",value:t.description,onChange:s=>l(r=>({...r,description:s.target.value}))})]}),e.jsx("div",{className:"field-wrapper",children:e.jsxs("label",{className:"switch",children:[e.jsx("input",{type:"checkbox",checked:t.active,onChange:s=>l(r=>({...r,active:s.target.checked}))}),e.jsx("span",{className:"slider round"}),e.jsx("span",{children:"Скрыть из меню"})]})}),e.jsxs("div",{...b(),className:"dish-form-upload",children:[e.jsx("input",{...j()}),e.jsxs("button",{className:"dish-upload-button",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512",children:e.jsx("path",{d:"M288 109.3L288 352c0 17.7-14.3 32-32 32s-32-14.3-32-32l0-242.7-73.4 73.4c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l128-128c12.5-12.5 32.8-12.5 45.3 0l128 128c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L288 109.3zM64 352l128 0c0 35.3 28.7 64 64 64s64-28.7 64-64l128 0c35.3 0 64 28.7 64 64l0 32c0 35.3-28.7 64-64 64L64 512c-35.3 0-64-28.7-64-64l0-32c0-35.3 28.7-64 64-64zM432 456a24 24 0 1 0 0-48 24 24 0 1 0 0 48z"})}),t.photo?"Заменить фотографию":"Загрузить изображение"]}),t.photo&&e.jsx("img",{src:`https://booklink.pro/cf/photo?id=${t.photo}`,alt:"dish"})]}),e.jsx("button",{className:"secondary-button",onClick:h,children:"Добавить блюдо"}),e.jsx("div",{className:"new-dishes-container",children:a.filter(s=>!s._id).map(s=>e.jsxs("div",{className:"food-badge",children:[e.jsx("p",{children:s.name}),e.jsxs("div",{className:"action-buttons",children:[e.jsx("button",{onClick:()=>f(s),children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512",children:e.jsx("path",{d:"M362.7 19.3L314.3 67.7 444.3 197.7l48.4-48.4c25-25 25-65.5 0-90.5L453.3 19.3c-25-25-65.5-25-90.5 0zm-71 71L58.6 323.5c-10.4 10.4-18 23.3-22.2 37.4L1 481.2C-1.5 489.7 .8 498.8 7 505s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L421.7 220.3 291.7 90.3z"})})}),e.jsx("button",{onClick:()=>i(s.temp_id),children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 448 512",children:e.jsx("path",{d:"M135.2 17.7L128 32 32 32C14.3 32 0 46.3 0 64S14.3 96 32 96l384 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-96 0-7.2-14.3C307.4 6.8 296.3 0 284.2 0L163.8 0c-12.1 0-23.2 6.8-28.6 17.7zM416 128L32 128 53.2 467c1.6 25.3 22.6 45 47.9 45l245.8 0c25.3 0 46.3-19.7 47.9-45L416 128z"})})})]})]},s.temp_id))})]})},R=({dishes:a,onEdit:n})=>{var t;const[v,p]=d.useState(((t=a==null?void 0:a[0])==null?void 0:t.category)??"");if(a.length===0)return e.jsx("p",{children:"Нет блюд"});const f=a.reduce((l,c,g)=>{const x=c.category||"Без категории";return l[x]||(l[x]=[]),l[x].push({...c,index:g}),l},{});return e.jsxs("div",{className:"dish-list-container",children:[e.jsx("div",{className:"dish-categories-container",children:Object.keys(f).map(l=>e.jsxs("label",{className:"radio-input-label",children:[e.jsx("input",{type:"radio",name:"houseType",value:l,className:"radio-input",checked:v===l,onChange:c=>p(c.target.value)}),e.jsx("span",{className:"radio-input-text",children:l})]},l))}),e.jsx("div",{className:"dish-list",children:f[v]&&f[v].map(l=>e.jsxs("div",{className:"dish-card",children:[e.jsx("div",{className:"dish-card-image",children:e.jsx("img",{src:`https://booklink.pro/cf/photo?id=${l.photo}`,alt:""})}),e.jsxs("div",{className:"dish-details",children:[e.jsxs("span",{className:"dish-price",children:[l.price," сом"]}),e.jsxs("span",{className:"dish-weight",children:[l.weight," г / мл"]})]}),e.jsx("p",{className:"dish-title",children:l.name}),e.jsx("button",{className:"secondary-button",onClick:()=>n(l),children:"Редактировать"})]},l._id))})]})},P=({dish:a,categories:n,setCategories:v,onSave:p,onCancel:f})=>{const[t,l]=d.useState({...a}),[c,g]=d.useState(!1),[x,w]=d.useState(""),y=d.useCallback(async i=>{var m;const s=i[0],r=new FormData;r.append("photo",s);try{const N=await D.post("/photo/upload",r,{headers:{"Content-Type":"multipart/form-data"}});(m=N.data)!=null&&m.id&&l(C=>({...C,photo:N.data.id}))}catch(N){console.error("Upload error:",N)}},[]),{getRootProps:b,getInputProps:j}=L({accept:{"image/*":[]},maxFiles:1,onDrop:y}),o=i=>{const s=i.target.value;s==="__new__"?(g(!0),l(r=>({...r,category:""}))):(g(!1),l(r=>({...r,category:s})))},h=()=>{const i=c?x.trim():t.category;if(!t.name||!t.price||!t.weight||!i||!t.photo){alert("Заполните все поля");return}const s={...t,price:parseInt(t.price),weight:parseInt(t.weight),category:i};n.includes(i)||v(r=>[...r,i]),p(s)};return e.jsx("div",{children:e.jsxs("div",{onClick:i=>i.stopPropagation(),children:[e.jsx("h3",{children:"Редактировать блюдо"}),e.jsxs("div",{className:"field-wrapper",children:[e.jsx("label",{htmlFor:"name",className:"field-label",children:"Название"}),e.jsx("input",{type:"text",id:"name",className:"text-field",value:t.name,onChange:i=>l(s=>({...s,name:i.target.value}))})]}),e.jsxs("div",{className:"group-form",children:[e.jsxs("div",{className:"field-wrapper",children:[e.jsx("label",{htmlFor:"price",className:"field-label",children:"Цена"}),e.jsx("input",{type:"number",id:"price",className:"text-field",value:t.price,onChange:i=>l(s=>({...s,price:i.target.value}))})]}),e.jsxs("div",{className:"field-wrapper",children:[e.jsx("label",{htmlFor:"weight",className:"field-label",children:"Вес / объем"}),e.jsx("input",{type:"text",id:"weight",className:"text-field",value:t.weight,onChange:i=>l(s=>({...s,weight:i.target.value}))})]})]}),e.jsxs("div",{className:"field-wrapper select-wrapper",children:[e.jsx("label",{htmlFor:"category",className:"field-label",children:"Категория"}),e.jsxs("select",{id:"category",className:"select-field",value:c?"__new__":t.category,onChange:o,children:[e.jsx("option",{value:"",disabled:!0,children:"Выбрать категорию"}),n.map((i,s)=>e.jsx("option",{value:i,children:i},s)),e.jsx("option",{value:"__new__",children:"Добавить новую категорию"})]})]}),c&&e.jsxs("div",{className:"field-wrapper",children:[e.jsx("label",{htmlFor:"new-category",className:"field-label",children:"Новая категория"}),e.jsx("input",{id:"new-category",type:"text",className:"text-field",value:x,onChange:i=>w(i.target.value)})]}),e.jsxs("div",{className:"field-wrapper",children:[e.jsx("label",{htmlFor:"description",className:"field-label",children:"Описание"}),e.jsx("textarea",{id:"description",rows:"3",className:"text-field",value:t.description,onChange:i=>l(s=>({...s,description:i.target.value}))})]}),e.jsx("div",{className:"field-wrapper",children:e.jsxs("label",{className:"switch",children:[e.jsx("input",{type:"checkbox",checked:t.active,onChange:i=>l(s=>({...s,active:i.target.checked}))}),e.jsx("span",{className:"slider round"}),e.jsx("span",{children:"Скрыть из меню"})]})}),e.jsxs("div",{...b(),className:"dish-form-upload",children:[e.jsx("input",{...j()}),e.jsxs("button",{className:"dish-upload-button",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512",children:e.jsx("path",{d:"M288 109.3L288 352c0 17.7-14.3 32-32 32s-32-14.3-32-32l0-242.7-73.4 73.4c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l128-128c12.5-12.5 32.8-12.5 45.3 0l128 128c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L288 109.3zM64 352l128 0c0 35.3 28.7 64 64 64s64-28.7 64-64l128 0c35.3 0 64 28.7 64 64l0 32c0 35.3-28.7 64-64 64L64 512c-35.3 0-64-28.7-64-64l0-32c0-35.3 28.7-64 64-64zM432 456a24 24 0 1 0 0-48 24 24 0 1 0 0 48z"})}),t.photo?"Заменить фотографию":"Загрузить изображение"]}),t.photo&&e.jsx("img",{src:`https://booklink.pro/cf/photo?id=${t.photo}`,alt:"dish"})]}),e.jsxs("div",{className:"edit-buttons",children:[e.jsx("button",{onClick:h,className:"primary-button",children:"Применить изменения"}),e.jsx("button",{onClick:f,className:"secondary-button",children:"Отмена"})]})]})})},W=()=>{const[a]=M(),[n,v]=d.useState([]),[p,f]=d.useState([]),[t,l]=d.useState([]),[c,g]=d.useState(null),[x,w]=d.useState("create");d.useEffect(()=>{(async()=>{try{const o=await D.get(`/foods?partner_id=${a.get("chat_id")}`);if(Array.isArray(o.data)){v(o.data),f(o.data);const h=Array.from(new Set(o.data.map(i=>i.category).filter(Boolean)));l(h)}}catch(o){console.error("Ошибка загрузки блюд",o)}})()},[a]);const y=d.useCallback(()=>{const j=n.filter(o=>{const h=p.find(i=>i._id===o._id);return!h||!S(h,o)});console.log("Changed Dishes:",j),_.sendData(JSON.stringify(j))},[n,p]),b=d.useMemo(()=>n.some(o=>{const h=p.find(i=>i._id===o._id);return!h||!S(h,o)}),[n,p]);return d.useEffect(()=>(_.MainButton.setText("Обновить меню"),b?_.MainButton.show():_.MainButton.hide(),_.onEvent("mainButtonClicked",y),()=>_.offEvent("mainButtonClicked",y)),[b,y]),e.jsxs("div",{className:"create-menu-container",children:[e.jsxs("div",{className:"field-wrapper",children:[e.jsx("span",{className:"field-label",children:"Добавить блюдо или редактировать меню:"}),e.jsxs("div",{className:"operation-type-switchers",children:[e.jsxs("label",{className:"radio-input-label",children:[e.jsx("input",{type:"radio",name:"operation",value:"create",className:"radio-input",checked:x==="create",onChange:j=>w(j.target.value)}),e.jsx("span",{className:"radio-input-text",children:"Добавить"})]}),e.jsxs("label",{className:"radio-input-label",children:[e.jsx("input",{type:"radio",name:"operation",value:"edit",className:"radio-input",checked:x==="edit",onChange:j=>w(j.target.value)}),e.jsx("span",{className:"radio-input-text",children:"Меню"})]})]})]}),c!==null?e.jsxs("div",{children:[e.jsx("button",{className:"back-button",onClick:()=>g(null),children:"« Назад"}),e.jsx(P,{dish:c,categories:t,setCategories:l,onSave:j=>{v(o=>o.map(h=>{const i=h._id&&c._id&&h._id===c._id,s=h.temp_id&&c.temp_id&&h.temp_id===c.temp_id;return i||s?j:h})),g(null)},onCancel:()=>g(null)})]}):e.jsx(e.Fragment,{children:x==="create"?e.jsx(T,{dishes:n,setDishes:v,categories:t,setCategories:l,setEditingDish:g}):e.jsx(R,{dishes:n,onEdit:g})})]})};export{W as default};
